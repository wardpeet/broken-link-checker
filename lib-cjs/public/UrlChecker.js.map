{"version":3,"file":"UrlChecker.js","names":["_checkLink","_interopRequireDefault","require","_events","_isurl","_Link","_interopRequireWildcard","_parseOptions","_limitedRequestQueue","_SafeEventEmitter","_urlcache","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","UrlChecker","SafeEventEmitter","cache","linkQueue","constructor","options","parseOptions","URLCache","maxAge","cacheMaxAge","RequestQueue","maxSockets","maxSocketsPerHost","rateLimit","on","ITEM_EVENT","url","auth","customData","link","done","result","checkLink","WAS_EXCLUDED","htmlTagName","emit","JUNK_EVENT","LINK_EVENT","REQUEST_QUEUE_END_EVENT","END_EVENT","clearCache","clear","dequeue","id","success","QUEUE_EVENT","enqueue","Link","isURL","resolve","TypeError","REBASED_URL","isPaused","numActiveLinks","numActive","numQueuedLinks","numQueued","pause","resume","__cache","exports","module"],"sources":["../../lib/public/UrlChecker.js"],"sourcesContent":["import checkLink from \"../internal/checkLink\";\nimport {\n  END_EVENT,\n  JUNK_EVENT,\n  LINK_EVENT,\n  QUEUE_EVENT,\n} from \"../internal/events\";\nimport isURL from \"isurl\";\nimport Link, { REBASED_URL, WAS_EXCLUDED } from \"../internal/Link\";\nimport parseOptions from \"../internal/parseOptions\";\nimport RequestQueue, {\n  ITEM_EVENT,\n  END_EVENT as REQUEST_QUEUE_END_EVENT,\n} from \"limited-request-queue\";\nimport SafeEventEmitter from \"../internal/SafeEventEmitter\";\nimport URLCache from \"urlcache\";\n\nexport default class UrlChecker extends SafeEventEmitter {\n  #cache;\n  #linkQueue;\n\n  constructor(options) {\n    super();\n\n    options = parseOptions(options);\n\n    this.#cache = new URLCache({ maxAge: options.cacheMaxAge });\n\n    this.#linkQueue = new RequestQueue({\n      maxSockets: options.maxSockets,\n      maxSocketsPerHost: options.maxSocketsPerHost,\n      rateLimit: options.rateLimit,\n    })\n      .on(ITEM_EVENT, async (url, { auth, customData, link }, done) => {\n        const result = await checkLink(link, auth, this.#cache, options);\n\n        if (result.get(WAS_EXCLUDED) || link.htmlTagName === \"button\") {\n          this.emit(JUNK_EVENT, result, customData);\n        } else {\n          this.emit(LINK_EVENT, result, customData);\n        }\n\n        // Auto-starts next queue item, if any\n        // Emits REQUEST_QUEUE_END_EVENT, if not\n        done();\n      })\n      .on(REQUEST_QUEUE_END_EVENT, () => this.emit(END_EVENT));\n  }\n\n  clearCache() {\n    this.#cache.clear();\n    return this;\n  }\n\n  dequeue(id) {\n    const success = this.#linkQueue.dequeue(id);\n\n    this.emit(QUEUE_EVENT);\n\n    return success;\n  }\n\n  // `auth` is undocumented and for internal use only\n  enqueue(url, customData, auth = {}) {\n    let link;\n\n    // Undocumented internal use: `enqueue(Link)`\n    if (url instanceof Link) {\n      link = url;\n    }\n    // Documented use: `enqueue(URL)`\n    else if (isURL(url)) {\n      link = new Link().resolve(url);\n    } else {\n      throw new TypeError(\"Invalid URL\");\n    }\n\n    const id = this.#linkQueue.enqueue(link.get(REBASED_URL), {\n      auth,\n      customData,\n      link,\n    });\n\n    this.emit(QUEUE_EVENT);\n\n    return id;\n  }\n\n  has(id) {\n    return this.#linkQueue.has(id);\n  }\n\n  get isPaused() {\n    return this.#linkQueue.isPaused;\n  }\n\n  get numActiveLinks() {\n    return this.#linkQueue.numActive;\n  }\n\n  get numQueuedLinks() {\n    return this.#linkQueue.numQueued;\n  }\n\n  pause() {\n    this.#linkQueue.pause();\n    return this;\n  }\n\n  resume() {\n    this.#linkQueue.resume();\n    return this;\n  }\n\n  get __cache() {\n    return this.#cache;\n  }\n}\n"],"mappings":"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","ignoreList":[]}